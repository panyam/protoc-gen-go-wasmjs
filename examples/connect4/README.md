# Connect4 with Stateful Proxies

This example demonstrates the **stateful proxy extension** for `protoc-gen-go-wasmjs`, which enables real-time collaborative applications with efficient differential updates.

## What are Stateful Proxies?

Stateful proxies provide:

1. **Differential Updates**: Instead of sending entire game states, only changes (patches) are transmitted
2. **Conflict Resolution**: Built-in strategies for handling concurrent modifications
3. **Transport Agnostic**: Works with WebSockets, WebRTC, or any real-time transport
4. **Type Safety**: Generated TypeScript proxies with full type checking
5. **Optimized WASM Boundaries**: Minimal serialization overhead between WASM and JavaScript

## ğŸ® Game Features

- **2-10 players** with unique colors
- **Configurable board** sizes (7x7 to 20x20)
- **Real-time collaboration** via stateful proxies
- **Gravity-based piece placement**
- **Multiple winners** support
- **Turn-based gameplay** with validation
- **Line detection** (horizontal, vertical, diagonal)

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    WebSocket    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser A     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   Browser B     â”‚
â”‚                 â”‚                  â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Stateful    â”‚ â”‚                  â”‚ â”‚ Stateful    â”‚ â”‚
â”‚ â”‚ Proxy       â”‚ â”‚                  â”‚ â”‚ Proxy       â”‚ â”‚
â”‚ â”‚ (TypeScript)â”‚ â”‚                  â”‚ â”‚ (TypeScript)â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚        â”‚                  â”‚        â”‚        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ WASM        â”‚ â”‚    HTTP/gRPC     â”‚ â”‚ WASM        â”‚ â”‚
â”‚ â”‚ Service     â”‚ â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ â”‚ Service     â”‚ â”‚
â”‚ â”‚ (Go)        â”‚ â”‚                  â”‚ â”‚ (Go)        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Game Server     â”‚
                   â”‚ (Authoritative) â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
                            â”‚ â€¢ WebSocket      â”‚
                            â”‚ â€¢ Server Events  â”‚
                            â”‚ â€¢ Polling        â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Getting Started

### Prerequisites
- Go 1.21+
- Node.js (for development server)
- Buf CLI (`brew install bufbuild/buf/buf`)

### Build & Run

1. **Generate protobuf code:**
   ```bash
   make generate
   ```

2. **Build WASM service:**
   ```bash
   make wasm
   ```

3. **Start development server:**
   ```bash
   make web
   # Open http://localhost:8080
   ```

### Test Stateful Proxy Generation

```bash
make test
```

## ğŸ“ Project Structure

```
examples/connect4/
â”œâ”€â”€ proto/connect4/
â”‚   â””â”€â”€ game.proto              # Service definitions with stateful annotations
â”œâ”€â”€ wasm/
â”‚   â””â”€â”€ service.go              # Go WASM service implementation
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ index.html              # Game UI
â”‚   â”œâ”€â”€ game.js                 # Client-side game logic
â”‚   â””â”€â”€ gen/                    # Generated stateful proxies
â”œâ”€â”€ gen/                        # Generated protobuf code
â”œâ”€â”€ buf.yaml                    # Buf configuration
â”œâ”€â”€ buf.gen.yaml               # Code generation config
â””â”€â”€ Makefile                   # Build automation
```

## ğŸ¯ Key Stateful Features

### Service Annotations
```protobuf
service Connect4Service {
  option (wasmjs.v1.stateful) = {
    enabled: true
    state_message_type: "connect4.GameState"
    conflict_resolution: CHANGE_NUMBER_BASED
  };
  
  rpc DropPiece(DropPieceRequest) returns (DropPieceResponse) {
    option (wasmjs.v1.stateful_method) = {
      returns_patches: true
      broadcasts: true
    };
  };
}
```

### Generated Stateful Proxy
```typescript
// Auto-generated by protoc-gen-go-wasmjs-stateful
export class StatefulConnect4ServiceProxy {
  applyPatches(patches: MessagePatch[], changeNumber: number): boolean;
  getState(): GameState | null;
  subscribe(callback: (state: GameState) => void): () => void;
}
```

### Real-time Updates
```typescript
// All players see moves instantly
gameProxy.subscribe((gameState) => {
  renderBoard(gameState.board);
  updatePlayerList(gameState.players);
  highlightCurrentPlayer(gameState.currentPlayerId);
});

// Transport-agnostic patch application
transport.onChanges((patches) => {
  gameProxy.applyPatches(patches, changeNumber);
});
```

## ğŸ§ª Game Rules & Validation

### Valid Moves
âœ… **Turn-based** - Only current player can move  
âœ… **Column bounds** - Must be within board width  
âœ… **Available space** - Column not full  
âœ… **Gravity** - Pieces fall to lowest position  

### Invalid Moves
âŒ **Out of turn** - Not your turn  
âŒ **Full column** - No space available  
âŒ **Invalid column** - Outside board bounds  

### Winning Conditions
ğŸ† **Connect 4** - Horizontal, vertical, or diagonal  
ğŸ† **Multiple winners** - Game continues (configurable)  
ğŸ† **Score tracking** - Pieces played, lines formed  

## ğŸ“Š Performance Benefits

- **Optimistic Updates** - Instant UI feedback
- **Differential Patches** - Only send changes, not full state
- **Transport Flexibility** - WebSocket, SSE, or polling
- **Conflict Resolution** - Change-number based ordering
- **WASM Validation** - Complex game logic in performant WASM

## ğŸ”§ Development

### Generate Only Stateful Proxies
```bash
make stateful
```

### Clean Generated Files
```bash
make clean
```

### Customize Board Size
Edit `game.proto` and modify `GameConfig` defaults, then regenerate.

This example showcases how stateful proxies enable **real-time collaborative applications** with minimal client-side complexity!
