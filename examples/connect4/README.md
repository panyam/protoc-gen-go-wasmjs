# Connect4 with Stateful Proxies

This example demonstrates the **stateful proxy extension** for `protoc-gen-go-wasmjs`, which enables real-time collaborative applications with efficient differential updates.

## What are Stateful Proxies?

Stateful proxies provide:

1. **Differential Updates**: Instead of sending entire game states, only changes (patches) are transmitted
2. **Conflict Resolution**: Built-in strategies for handling concurrent modifications
3. **Transport Agnostic**: Works with WebSockets, WebRTC, or any real-time transport
4. **Type Safety**: Generated TypeScript proxies with full type checking
5. **Optimized WASM Boundaries**: Minimal serialization overhead between WASM and JavaScript

## 🎮 Game Features

- **2-10 players** with unique colors
- **Configurable board** sizes (7x7 to 20x20)
- **Real-time collaboration** via stateful proxies
- **Gravity-based piece placement**
- **Multiple winners** support
- **Turn-based gameplay** with validation
- **Line detection** (horizontal, vertical, diagonal)

## 🏗️ Architecture

```
┌─────────────────┐    WebSocket    ┌─────────────────┐
│   Browser A     │ ◄──────────────► │   Browser B     │
│                 │                  │                 │
│ ┌─────────────┐ │                  │ ┌─────────────┐ │
│ │ Stateful    │ │                  │ │ Stateful    │ │
│ │ Proxy       │ │                  │ │ Proxy       │ │
│ │ (TypeScript)│ │                  │ │ (TypeScript)│ │
│ └─────────────┘ │                  │ └─────────────┘ │
│        │        │                  │        │        │
│ ┌─────────────┐ │                  │ ┌─────────────┐ │
│ │ WASM        │ │    HTTP/gRPC     │ │ WASM        │ │
│ │ Service     │ │ ◄──────────────► │ │ Service     │ │
│ │ (Go)        │ │                  │ │ (Go)        │ │
│ └─────────────┘ │                  │ └─────────────┘ │
└─────────────────┘                  └─────────────────┘
                            │
                   ┌─────────────────┐
                   │ Game Server     │
                   │ (Authoritative) │
                   └─────────────────┘
```
                            │ • WebSocket      │
                            │ • Server Events  │
                            │ • Polling        │
                            └──────────────────┘
```

## 🚀 Getting Started

### Prerequisites
- Go 1.21+
- Node.js (for development server)
- Buf CLI (`brew install bufbuild/buf/buf`)

### Build & Run

1. **Generate protobuf code:**
   ```bash
   make generate
   ```

2. **Build WASM service:**
   ```bash
   make wasm
   ```

3. **Start development server:**
   ```bash
   make web
   # Open http://localhost:8080
   ```

### Test Stateful Proxy Generation

```bash
make test
```

## 📁 Project Structure

```
examples/connect4/
├── proto/connect4/
│   └── game.proto              # Service definitions with stateful annotations
├── wasm/
│   └── service.go              # Go WASM service implementation
├── web/
│   ├── index.html              # Game UI
│   ├── game.js                 # Client-side game logic
│   └── gen/                    # Generated stateful proxies
├── gen/                        # Generated protobuf code
├── buf.yaml                    # Buf configuration
├── buf.gen.yaml               # Code generation config
└── Makefile                   # Build automation
```

## 🎯 Key Stateful Features

### Service Annotations
```protobuf
service Connect4Service {
  option (wasmjs.v1.stateful) = {
    enabled: true
    state_message_type: "connect4.GameState"
    conflict_resolution: CHANGE_NUMBER_BASED
  };
  
  rpc DropPiece(DropPieceRequest) returns (DropPieceResponse) {
    option (wasmjs.v1.stateful_method) = {
      returns_patches: true
      broadcasts: true
    };
  };
}
```

### Generated Stateful Proxy
```typescript
// Auto-generated by protoc-gen-go-wasmjs-stateful
export class StatefulConnect4ServiceProxy {
  applyPatches(patches: MessagePatch[], changeNumber: number): boolean;
  getState(): GameState | null;
  subscribe(callback: (state: GameState) => void): () => void;
}
```

### Real-time Updates
```typescript
// All players see moves instantly
gameProxy.subscribe((gameState) => {
  renderBoard(gameState.board);
  updatePlayerList(gameState.players);
  highlightCurrentPlayer(gameState.currentPlayerId);
});

// Transport-agnostic patch application
transport.onChanges((patches) => {
  gameProxy.applyPatches(patches, changeNumber);
});
```

## 🧪 Game Rules & Validation

### Valid Moves
✅ **Turn-based** - Only current player can move  
✅ **Column bounds** - Must be within board width  
✅ **Available space** - Column not full  
✅ **Gravity** - Pieces fall to lowest position  

### Invalid Moves
❌ **Out of turn** - Not your turn  
❌ **Full column** - No space available  
❌ **Invalid column** - Outside board bounds  

### Winning Conditions
🏆 **Connect 4** - Horizontal, vertical, or diagonal  
🏆 **Multiple winners** - Game continues (configurable)  
🏆 **Score tracking** - Pieces played, lines formed  

## 📊 Performance Benefits

- **Optimistic Updates** - Instant UI feedback
- **Differential Patches** - Only send changes, not full state
- **Transport Flexibility** - WebSocket, SSE, or polling
- **Conflict Resolution** - Change-number based ordering
- **WASM Validation** - Complex game logic in performant WASM

## 🔧 Development

### Generate Only Stateful Proxies
```bash
make stateful
```

### Clean Generated Files
```bash
make clean
```

### Customize Board Size
Edit `game.proto` and modify `GameConfig` defaults, then regenerate.

This example showcases how stateful proxies enable **real-time collaborative applications** with minimal client-side complexity!
