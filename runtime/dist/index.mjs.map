{"version":3,"sources":["../src/browser/service-manager.ts","../src/schema/types.ts","../src/client/types.ts","../src/types/patches.ts"],"names":["FieldType","PatchOperation","PatchSource"],"mappings":"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","file":"index.mjs","sourcesContent":["// Copyright 2025 Sri Panyam\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//  http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * Browser Service Manager\n * Handles FIFO processing of browser service calls from WASM\n * This is a shared component used by all WASM clients that interact with browser services\n */\nexport class BrowserServiceManager {\n    private processing = false;\n    private serviceImplementations = new Map<string, any>();\n    private wasmModule: any;\n\n    constructor() {\n        // WASM will set up the global functions __wasmGetNextBrowserCall and __wasmDeliverBrowserResponse\n        // We'll just use them when they're available\n    }\n\n    /**\n     * Register a browser service implementation\n     */\n    registerService(name: string, implementation: any): void {\n        this.serviceImplementations.set(name, implementation);\n    }\n\n    /**\n     * Set the WASM module reference\n     */\n    setWasmModule(wasmModule: any): void {\n        this.wasmModule = wasmModule;\n    }\n\n    /**\n     * Start processing browser service calls\n     */\n    async startProcessing(): Promise<void> {\n        if (this.processing) return;\n        this.processing = true;\n\n        // Process calls in a loop\n        while (this.processing) {\n            const call = this.getNextBrowserCall();\n            if (!call) {\n                // No pending calls, wait a bit\n                await new Promise(resolve => setTimeout(resolve, 10));\n                continue;\n            }\n\n            // Process each call asynchronously without blocking the loop\n            this.processCall(call);\n        }\n    }\n\n    /**\n     * Process a single browser service call asynchronously\n     */\n    private async processCall(call: any): Promise<void> {\n        try {\n            // Get the service implementation\n            const service = this.serviceImplementations.get(call.service);\n            if (!service) {\n                throw new Error(`No implementation registered for service: ${call.service}`);\n            }\n\n            // Get the method\n            const methodName = call.method.charAt(0).toLowerCase() + call.method.slice(1);\n            const method = service[methodName];\n            if (!method) {\n                throw new Error(`Method ${methodName} not found on service ${call.service}`);\n            }\n\n            // Parse request\n            const request = JSON.parse(call.request);\n\n            // Call the method (auto-await if async)\n            const response = await Promise.resolve(method.call(service, request));\n\n            // Deliver response\n            this.deliverBrowserResponse(call.id, JSON.stringify(response), null);\n        } catch (error: any) {\n            // Deliver error\n            this.deliverBrowserResponse(call.id, null, error.message || String(error));\n        }\n    }\n\n    /**\n     * Stop processing browser service calls\n     */\n    stopProcessing(): void {\n        this.processing = false;\n    }\n\n    /**\n     * Get the next browser call from WASM\n     */\n    private getNextBrowserCall(): any {\n        // The __wasmGetNextBrowserCall function should be provided by WASM\n        if (typeof (window as any).__wasmGetNextBrowserCall === 'function') {\n            return (window as any).__wasmGetNextBrowserCall();\n        }\n        return null;\n    }\n\n    /**\n     * Deliver a response back to WASM (called internally)\n     */\n    private deliverBrowserResponse(callId: string, response: string | null, error: string | null): boolean {\n        if (!(window as any).__wasmDeliverBrowserResponse) {\n            return false;\n        }\n        return (window as any).__wasmDeliverBrowserResponse(callId, response, error);\n    }\n}\n","// Copyright 2025 Sri Panyam\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//  http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * Field type enumeration for proto field types\n */\nexport enum FieldType {\n  STRING = \"string\",\n  NUMBER = \"number\", \n  BOOLEAN = \"boolean\",\n  MESSAGE = \"message\",\n  REPEATED = \"repeated\",\n  MAP = \"map\",\n  ONEOF = \"oneof\"\n}\n\n/**\n * Schema interface for field definitions\n */\nexport interface FieldSchema {\n  name: string;\n  type: FieldType;\n  id: number; // Proto field number (e.g., text_query = 1)\n  messageType?: string; // For MESSAGE type fields\n  repeated?: boolean; // For array fields\n  mapKeyType?: FieldType; // For MAP type fields\n  mapValueType?: FieldType | string; // For MAP type fields\n  oneofGroup?: string; // For ONEOF fields\n  optional?: boolean;\n}\n\n/**\n * Message schema interface\n */\nexport interface MessageSchema {\n  name: string;\n  fields: FieldSchema[];\n  oneofGroups?: string[]; // List of oneof group names\n}\n","// Copyright 2025 Sri Panyam\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//  http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * WASM Response interface for all service calls\n */\nexport interface WASMResponse<T = any> {\n    success: boolean;\n    message: string;\n    data: T;\n}\n\n/**\n * Error class for WASM-specific errors\n */\nexport class WasmError extends Error {\n    constructor(message: string, public readonly methodPath?: string) {\n        super(message);\n        this.name = 'WasmError';\n    }\n}\n","// Copyright 2025 Sri Panyam\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//  http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * Patch operations for modifying protobuf message fields\n */\nexport enum PatchOperation {\n  SET = 'SET',\n  INSERT_LIST = 'INSERT_LIST',\n  REMOVE_LIST = 'REMOVE_LIST',\n  MOVE_LIST = 'MOVE_LIST',\n  INSERT_MAP = 'INSERT_MAP',\n  REMOVE_MAP = 'REMOVE_MAP',\n  CLEAR_LIST = 'CLEAR_LIST',\n  CLEAR_MAP = 'CLEAR_MAP',\n}\n\n/**\n * A single patch operation on a protobuf message field\n */\nexport interface MessagePatch {\n  /** The type of operation to perform */\n  operation: PatchOperation;\n  \n  /** Path to the field being modified (e.g., \"players[2].name\", \"places['tile_123'].latitude\") */\n  fieldPath: string;\n  \n  /** The new value to set (for SET, INSERT_LIST, INSERT_MAP operations) */\n  value?: any;\n  \n  /** Index for list operations (INSERT_LIST, REMOVE_LIST, MOVE_LIST) */\n  index?: number;\n  \n  /** Map key for map operations (INSERT_MAP, REMOVE_MAP) */\n  key?: string;\n  \n  /** Source index for MOVE_LIST operations */\n  oldIndex?: number;\n  \n  /** Monotonically increasing change number for ordering */\n  changeNumber: number;\n  \n  /** Timestamp when the change was created (microseconds since epoch) */\n  timestamp: number;\n  \n  /** Optional user ID who made the change (for conflict resolution) */\n  userId?: string;\n  \n  /** Optional transaction ID to group related patches */\n  transactionId?: string;\n}\n\n/**\n * A batch of patches applied to a single entity\n */\nexport interface PatchBatch {\n  /** The fully qualified protobuf message type (e.g., \"example.Game\") */\n  messageType: string;\n  \n  /** The unique identifier of the entity being modified */\n  entityId: string;\n  \n  /** List of patches to apply in order */\n  patches: MessagePatch[];\n  \n  /** The highest change number in this batch */\n  changeNumber: number;\n  \n  /** Source of the changes */\n  source: PatchSource;\n  \n  /** Optional metadata about the batch */\n  metadata?: Record<string, string>;\n}\n\n/**\n * Source of patch changes\n */\nexport enum PatchSource {\n  LOCAL = 'LOCAL',\n  REMOTE = 'REMOTE', \n  SERVER = 'SERVER',\n  STORAGE = 'STORAGE',\n}\n\n/**\n * Response message for methods that return patches\n */\nexport interface PatchResponse {\n  /** The patches to apply */\n  patchBatches: PatchBatch[];\n  \n  /** Success status */\n  success: boolean;\n  \n  /** Error message if success is false */\n  errorMessage?: string;\n  \n  /** The new change number after applying these patches */\n  newChangeNumber: number;\n}\n\n/**\n * Transport interface for receiving patch updates\n */\nexport interface ChangeTransport {\n  /** Register callback for incoming changes */\n  onChanges(callback: (batches: PatchBatch[]) => void): void;\n  \n  /** Disconnect from the transport */\n  disconnect(): void;\n}\n"]}